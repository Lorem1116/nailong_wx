const GEMTD_HERO_LIST = {
  "h101": "npc_dota_hero_enchantress",
  "h102": "npc_dota_hero_puck",
  "h103": "npc_dota_hero_omniknight",
  "h104": "npc_dota_hero_wisp",
  "h105": "npc_dota_hero_ogre_magi",
  "h106": "npc_dota_hero_lion",
  "h107": "npc_dota_hero_keeper_of_the_light",
  "h108": "npc_dota_hero_rubick",
  "h109": "npc_dota_hero_jakiro",
  "h110": "npc_dota_hero_sand_king",
  "h111": "npc_dota_hero_ancient_apparition",
  "h112": "npc_dota_hero_earth_spirit",
  "h201": "npc_dota_hero_crystal_maiden",
  "h202": "npc_dota_hero_death_prophet",
  "h203": "npc_dota_hero_templar_assassin",
  "h204": "npc_dota_hero_lina",
  "h205": "npc_dota_hero_tidehunter",
  "h206": "npc_dota_hero_naga_siren",
  "h207": "npc_dota_hero_phoenix",
  "h208": "npc_dota_hero_dazzle",
  "h209": "npc_dota_hero_warlock",
  "h210": "npc_dota_hero_necrolyte",
  "h211": "npc_dota_hero_lich",
  "h212": "npc_dota_hero_furion",
  "h213": "npc_dota_hero_venomancer",
  "h214": "npc_dota_hero_kunkka",
  "h215": "npc_dota_hero_axe",
  "h216": "npc_dota_hero_slark",
  "h217": "npc_dota_hero_viper",
  "h218": "npc_dota_hero_tusk",
  "h219": "npc_dota_hero_abaddon",
  "h220": "npc_dota_hero_winter_wyvern",
  "h221": "npc_dota_hero_ember_spirit",
  "h301": "npc_dota_hero_windrunner",
  "h302": "npc_dota_hero_phantom_assassin",
  "h303": "npc_dota_hero_sniper",
  "h304": "npc_dota_hero_sven",
  "h305": "npc_dota_hero_luna",
  "h306": "npc_dota_hero_mirana",
  "h307": "npc_dota_hero_nevermore",
  "h308": "npc_dota_hero_queenofpain",
  "h309": "npc_dota_hero_juggernaut",
  "h310": "npc_dota_hero_pudge",
  "h311": "npc_dota_hero_shredder",
  "h312": "npc_dota_hero_slardar",
  "h313": "npc_dota_hero_antimage",
  "h314": "npc_dota_hero_bristleback",
  "h315": "npc_dota_hero_lycan",
  "h316": "npc_dota_hero_lone_druid",
  "h317": "npc_dota_hero_storm_spirit",
  "h318": "npc_dota_hero_obsidian_destroyer",
  "h319": "npc_dota_hero_grimstroke",
  "h401": "npc_dota_hero_vengefulspirit",
  "h402": "npc_dota_hero_invoker",
  "h403": "npc_dota_hero_alchemist",
  "h404": "npc_dota_hero_spectre",
  "h405": "npc_dota_hero_morphling",
  "h406": "npc_dota_hero_techies",
  "h407": "npc_dota_hero_chaos_knight",
  "h408": "npc_dota_hero_faceless_void",
  "h409": "npc_dota_hero_legion_commander",
  "h410": "npc_dota_hero_monkey_king",
  "h411": "npc_dota_hero_razor",
  "h412": "npc_dota_hero_tinker",
  "h413": "npc_dota_hero_pangolier",
  "h414": "npc_dota_hero_dark_willow",
  "h415": "npc_dota_hero_terrorblade",
  "h416": "npc_dota_hero_enigma",
  "e101": "圣洁精华",
  "e102": "玛瑙光泽",
  "e103": "芳晓之庆",
  "e104": "水晶裂痕",
  "e105": "腐化触须",
  "e106": "毒虫肆虐",
  "e107": "夜魇腐化",
  "e108": "夜魇荒芜",
  "e201": "暗淡幻象",
  "e202": "冥魂大帝",
  "e203": "翡翠外质",
  "e204": "祸乱之源",
  "e205": "毒蕈之径",
  "e206": "2012",
  "e207": "2013",
  "e208": "2014",
  "e301": "骄阳之炎",
  "e302": "嬉戏蝴蝶",
  "e303": "水晶室女",
  "e304": "幸福之赐",
  "e305": "绽放莲花",
  "e306": "迎霜冰雪",
  "e307": "燃烧末日",
  "e308": "鱼泡泡",
  "e401": "燃焰之触",
  "e402": "霜寒之触",
  "e403": "迈达斯之触",
  "e404": "离子之汽",
  "e109": "大地灵气",
  "e110": "蓝色风暴",
  "e309": "紫色激情",
  "e310": "白雪飘零",
  "e311": "一股邪火",
  "e209": "霓虹蝴蝶",
  "e210": "旋转火花",
  "e312": "金币飞舞",
  "e313": "光辉岁月",
  "e314": "紫色星云",
  "e315": "噩梦缠绕",
  "e111": "一起哈啤",
  "e112": "宝石光泽",
  "e211": "雾气环绕",
  "e212": "迷幻缠绕",
  "e405": "光芒万丈",
  "e316": "星星",
  "e113": "污污污污",
  "e499": "金龙鱼",
  "e114": "雾里看花",
  "e317": "心心相印",
  "e318": "2017",
  "e319": "灿若繁星",
  "e320": "大漩涡",
  "e407": "飞沙走石",
  "e406": "星光蓝宝石",
  "e409": "血之环",
  "e408": "暗月来袭",
  "e213": "小家碧玉",
  "e214": "欲火焚身",
  "e321": "通灵术",
  "e410": "雪精灵",
  "e450": "虚无之焰",
  "e451": "虚无之焰红",
  "e452": "虚无之焰橙",
  "e453": "虚无之焰黄",
  "e454": "虚无之焰绿",
  "e455": "虚无之焰青",
  "e456": "虚无之焰蓝",
  "e457": "虚无之焰紫",
  "e458": "虚无之焰白",
  "e459": "虚无之焰粉",
}

const heroes_translation = {
  "npc_dota_hero_enchantress": "魅惑魔女",
  "npc_dota_hero_puck": "帕克",
  "npc_dota_hero_omniknight": "全能骑士",
  "npc_dota_hero_wisp": "艾欧",
  "npc_dota_hero_ogre_magi": "食人魔法师",
  "npc_dota_hero_lion": "莱恩",
  "npc_dota_hero_keeper_of_the_light": "光之守卫",
  "npc_dota_hero_rubick": "拉比克",
  "npc_dota_hero_jakiro": "杰奇洛",
  "npc_dota_hero_sand_king": "沙王",
  "npc_dota_hero_ancient_apparition": "远古冰魂",
  "npc_dota_hero_earth_spirit": "大地之灵",
  "npc_dota_hero_crystal_maiden": "水晶室女",
  "npc_dota_hero_death_prophet": "死亡先知",
  "npc_dota_hero_templar_assassin": "圣堂刺客",
  "npc_dota_hero_lina": "莉娜",
  "npc_dota_hero_tidehunter": "潮汐猎人",
  "npc_dota_hero_naga_siren": "娜迦海妖",
  "npc_dota_hero_phoenix": "凤凰",
  "npc_dota_hero_dazzle": "戴泽",
  "npc_dota_hero_warlock": "术士",
  "npc_dota_hero_necrolyte": "瘟疫法师",
  "npc_dota_hero_lich": "巫妖",
  "npc_dota_hero_furion": "先知",
  "npc_dota_hero_venomancer": "剧毒术士",
  "npc_dota_hero_kunkka": "昆卡",
  "npc_dota_hero_axe": "斧王",
  "npc_dota_hero_slark": "斯拉克",
  "npc_dota_hero_viper": "冥界亚龙",
  "npc_dota_hero_tusk": "巨牙海民",
  "npc_dota_hero_abaddon": "亚巴顿",
  "npc_dota_hero_winter_wyvern": "寒冬飞龙",
  "npc_dota_hero_ember_spirit": "灰烬之灵",
  "npc_dota_hero_windrunner": "风行者",
  "npc_dota_hero_phantom_assassin": "幻影刺客",
  "npc_dota_hero_sniper": "狙击手",
  "npc_dota_hero_sven": "斯温",
  "npc_dota_hero_luna": "露娜",
  "npc_dota_hero_mirana": "米拉娜",
  "npc_dota_hero_nevermore": "影魔",
  "npc_dota_hero_queenofpain": "痛苦女王",
  "npc_dota_hero_juggernaut": "主宰",
  "npc_dota_hero_pudge": "帕吉",
  "npc_dota_hero_shredder": "伐木机",
  "npc_dota_hero_slardar": "斯拉达",
  "npc_dota_hero_antimage": "敌法师",
  "npc_dota_hero_bristleback": "钢背兽",
  "npc_dota_hero_lycan": "狼人",
  "npc_dota_hero_lone_druid": "德鲁伊",
  "npc_dota_hero_storm_spirit": "风暴之灵",
  "npc_dota_hero_obsidian_destroyer": "殁境神蚀者",
  "npc_dota_hero_grimstroke": "天涯墨客",
  "npc_dota_hero_vengefulspirit": "复仇之魂",
  "npc_dota_hero_invoker": "祈求者",
  "npc_dota_hero_alchemist": "炼金术士",
  "npc_dota_hero_spectre": "幽鬼",
  "npc_dota_hero_morphling": "变体精灵",
  "npc_dota_hero_techies": "工程师",
  "npc_dota_hero_chaos_knight": "混沌骑士",
  "npc_dota_hero_faceless_void": "虚空假面",
  "npc_dota_hero_legion_commander": "军团",
  "npc_dota_hero_monkey_king": "齐天大圣",
  "npc_dota_hero_razor": "闪电幽魂",
  "npc_dota_hero_tinker": "修补匠",
  "npc_dota_hero_pangolier": "石鳞剑士",
  "npc_dota_hero_dark_willow": "邪影芳灵",
  "npc_dota_hero_terrorblade": "恐怖利刃",
  "npc_dota_hero_enigma": "谜团",
}
function getRandomInt(min, max) {
  min = Math.ceil(min); // 向上取整
  max = Math.floor(max); // 向下取整
  return Math.floor(Math.random() * (max - min + 1)) + min; // 含最小值，含最大值 
}
const app = getApp();
Page({
  data: {
    person: {},
    ondutyHero: {},
    heroList: []
  },
  setOnDutyHero: function (e) {
    const that = this
    const hero = e.currentTarget.dataset.hero
    const randomNumber = getRandomInt(1, 10000);
    const url = "http://gemtd.ppbizon.com/gemtd/hero/save/" + hero.hero_id + "@" + that.data.person.id + "?hehe=" + randomNumber
    wx.showModal({
      title: 'warning',
      content: '你确定要更换英雄吗？',
      cancelColor: "#606c38",
      success: function (res) {
        if (res.confirm) {
          wx.cloud.callFunction({
            name: 'requestGEM',
            data: {
              url: url
            },
            success: res => {
              wx.showLoading({
                title: '更换中',
              })
              const randomNumber = getRandomInt(1, 10000);
              const url = "http://gemtd.ppbizon.com/gemtd/202203/heros/get/@" + that.data.person.id + "?hehe=" + randomNumber
              wx.cloud.callFunction({
                name: 'requestGEM',
                data: {
                  url: url
                },
                success: res => {
                  wx.setStorageSync('gemInfo', res.result.data[that.data.person.id])
                  that.setData({
                    ondutyHero: hero
                  })
                  wx.hideLoading();
                },
                fail: res =>{
                  wx.showToast({
                    title: '更换失败',
                  })
                }
              })
            }
          })
        }
      }
    })

  },
  onShow: function () {
    if (app.globalData.fromPageA) {
      app.eventHandler.on('steamInfoUpdate', (data) => {
        console.log("接受信号")
        let person_ = this.data.person
        person_.avatarUrl = data.avatarmedium
        person_.name = data.personaname
        this.setData({person: person_});
      });
      // 可以在这里调用API获取用户信息并设置data
      const steamInfo = wx.getStorageSync('steamInfo')
      const gemInfo = wx.getStorageSync('gemInfo')
      const avatarInfo = wx.getStorageSync('avatarInfo')
      let person = {}
      let onduty = {}
      let heroList = []
      if (steamInfo && gemInfo.rank_info.user == steamInfo.steamid) {
        person.avatarUrl = steamInfo.avatarmedium
        person.name = steamInfo.personaname
      } else if (avatarInfo && avatarInfo.some(element => element["id"] === gemInfo.rank_info.user)) {
        console.log("加载缓存")
        person = avatarInfo.find(element => element["id"] === gemInfo.rank_info.user)
      } else {
        person.avatarUrl = "/static/image/default.png"
        person.name = "steamid正在搜索..."
      }
      if (gemInfo) {
        person.id = gemInfo.rank_info.user
        person.totalRank = gemInfo.rank_info.score + 1
        person.gameRank = gemInfo.rank_info.rankall
        person.gameIcon = this.gamelevel(person.gameRank)
        person.coopRank = 26 - gemInfo.rank_info.coop_level
        person.coopIcon = "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/coop_rank_" + gemInfo.rank_info.coop_level + ".png"
        person.info1 = gemInfo.rank_info.best_kills.p1
        person.info2 = gemInfo.rank_info.best_kills.p2
        person.info3 = gemInfo.rank_info.best_kills.p3
        person.info4 = gemInfo.rank_info.best_kills.p4
        onduty = this.getHero(onduty, gemInfo.onduty_hero)
        Object.keys(gemInfo.hero_sea).forEach((key) => {
          gemInfo.hero_sea[key].hero_id = key
          let hero = {}
          hero = this.getHero(hero, gemInfo.hero_sea[key])
          heroList.push(hero)
        })
      }
      heroList.sort((a, b) => b.herolevel - a.herolevel)
      this.setData({
        person: person,
        ondutyHero: onduty,
        heroList: heroList
      })
      app.globalData.fromPageA = false;
    }else{
      let person = {}
      let onduty = {}
      let heroList = []
      this.setData({
        person: person,
        ondutyHero: onduty,
        heroList: heroList
      })
    }

  },
  getHero: function (onduty, gemInfo) {
    onduty.hero = "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/heros/" + GEMTD_HERO_LIST[gemInfo.hero_id] + ".png"
    onduty.hero_id = gemInfo.hero_id
    onduty.herolevel = Number(gemInfo.hero_id[1])
    onduty.heroName = heroes_translation[GEMTD_HERO_LIST[gemInfo.hero_id]]
    const level = {
      "0": "□□□□",
      "1": "■□□□",
      "2": "■■□□",
      "3": "■■■□",
      "4": "■■■■",
      "5":""
    }
    let ability = []
    Object.keys(gemInfo.ability).forEach((key) => {
      var skill = {"ability":"cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/lottery/gem_" + key + ".png","skillevel":level[gemInfo.ability[key]],"tag":false,"hero":gemInfo.hero_id}
      ability.push(skill)
    });
    let hero_length = parseInt(gemInfo.hero_id[1])
    if(gemInfo.extend){
      const extend = gemInfo.extend
      hero_length = hero_length + parseInt(extend)
    }
    const length = ability.length
    for (let i = 1; i <= hero_length - length; i++) {
      var skill = {"ability":"cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/lottery/empty.PNG","skillevel":level['0'],"tag":true,"hero":gemInfo.hero_id}
      ability.push(skill)
    }
    if(hero_length<4){
      for (let i = 1; i <= 4 - hero_length; i++) {
        var skill = {"ability":"cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/towers/award_item_extend.png","skillevel":level['5'],"tag":false,"hero":gemInfo.hero_id}
        ability.push(skill)
      }
    }
    onduty.ability = ability
    if (gemInfo.effect) {
      onduty.effectUrl = "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/lottery/" + gemInfo.effect + ".png"
      onduty.effect = GEMTD_HERO_LIST[gemInfo.effect]
      onduty.effectLevel = gemInfo.effect[1]
    } else {
      onduty.effectUrl = "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/lottery/empty.PNG"
      onduty.effect = "没有特效"
      onduty.effectLevel = 1
    }
    return onduty
  },
  gamelevel: function (rank) {
    if (0 < rank <= 100 && typeof rank === 'number') {
      return "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/all_rank_6.png"
    } else if (rank.slice(0, -1) == +"2") {
      return "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/all_rank_5.png"
    } else if (rank.slice(0, -1) <= +"10") {
      return "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/all_rank_4.png"
    } else if (rank.slice(0, -1) <= +"20") {
      return "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/all_rank_3.png"
    } else if (rank.slice(0, -1) <= +"50") {
      return "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/all_rank_2.png"
    } else {
      return "cloud://rebecca-2gbizwon5538bd4f.7265-rebecca-2gbizwon5538bd4f-1306855380/rank/all_rank_1.png"
    }
  },
  onLoad: function () {},

  navigateToSearch: function () {
    // 实现跳转到搜索页面的逻辑
    wx.navigateTo({
      url: '/pages/search/search'
    });
  }
});