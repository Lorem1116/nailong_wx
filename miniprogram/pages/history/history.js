var tower_name = { //要是有怪物进统计了 我们也把他显示出来(笑
  "gemtd_castle":"宝石城堡",
  "gemtd_stone":"石头",
  "gemtd_kuangbaoyezhu":"狂暴野猪",
  "gemtd_kuaidiqingwatiaotiao":"快递青蛙跳跳",
  "gemtd_zhongchenggaoshanmaoniu":"忠诚高山牦牛",
  "gemtd_moluokedejixiezhushou":"莫洛克的机械助手",
  "gemtd_wuweizhihuan_fly":"无畏之獾",
  "gemtd_shudunziranzhizhu":"树墩自然之助",
  "gemtd_chaomengjuxi":"超萌巨蜥",
  "gemtd_mengzhu":"萌蛛",
  "gemtd_dashiqi":"达士奇",
  "gemtd_maorongrongdefeiyangyang":"喜羊羊",
  "gemtd_caonimalama":"草泥马拉玛",
  "gemtd_fengtungongzhu":"丰臀公主",
  "gemtd_bugou":"布狗",
  "gemtd_banzhuduizhang_fly":"斑竹队长",
  "gemtd_xunjiemotong":"迅捷魔童",
  "gemtd_yonggandexiaoji":"勇敢的小鸡",
  "gemtd_xiaobajie":"小八戒",
  "gemtd_shentu":"神兔",
  "gemtd_siwangsiliezhe":"死亡撕裂者",
  "gemtd_yaorenxiangluoke":"咬人箱洛克",
  "gemtd_tiezuiyaorenxiang":"铁嘴咬人箱",
  "gemtd_jixieyaorenxiang":"机械咬人箱",
  "gemtd_fengbaozhizikesaier_fly":"风暴之子柯塞尔",
  "gemtd_niepanhuolieniao":"MVP的火烈鸟",
  "gemtd_lgddejinmengmeng_fly":"LGD的金萌萌",
  "gemtd_youniekesizhinu_fly":"IG的尤涅克斯之怒",
  "gemtd_feihuxia_fly":"VG的飞狐侠",
  "gemtd_modianxiaolong":"魔典小龙",
  "gemtd_xiaoshayu":"小鲨鱼",
  "gemtd_feijiangxiaobao":"飞僵小宝",
  "gemtd_shangjinbaobao_fly":"赏金宝宝",
  "gemtd_jinyinhuling_fly":"金银狐灵",
  "gemtd_jinyinhuling_fly1":"金银狐灵",
  "gemtd_yutumeixuan_tester":"玉兔美萱",
  "gemtd_cuihua":"翠花",
  "gemtd_cuihua1":"翠花",
  "gemtd_xiaobaihu":"小白虎",
  "gemtd_xiaoxingyue":"小星月",
  "gemtd_xiaoxingyue1":"小星月",
  "gemtd_liangqiyuhai_fly":"两栖鱼孩",
  "gemtd_juniaoduoduo_tester":"巨鸟多多",
  "gemtd_weilanlong":"蔚蓝龙",
  "gemtd_saodiekupu_fly":"骚蝶库普",
  "gemtd_jumenghaimin_tester":"巨萌海民",
  "gemtd_d1":"碎裂的钻石/D1",
  "gemtd_b1":"碎裂的蓝宝石/B1",
  "gemtd_y1":"碎裂的黄玉/Y1",
  "gemtd_r1":"碎裂的红宝石/R1",
  "gemtd_g1":"碎裂的翡翠/G1",
  "gemtd_e1":"碎裂的蛋白石/E1",
  "gemtd_q1":"碎裂的海晶石/Q1",
  "gemtd_p1":"碎裂的紫晶/P1",
  "gemtd_d11":"瑕疵的钻石/D2",
  "gemtd_b11":"瑕疵的蓝宝石/B2",
  "gemtd_y11":"瑕疵的黄玉/Y2",
  "gemtd_r11":"瑕疵的红宝石/R2",
  "gemtd_g11":"瑕疵的翡翠/G2",
  "gemtd_e11":"瑕疵的蛋白石/E2",
  "gemtd_q11":"瑕疵的海晶石/Q2",
  "gemtd_p11":"瑕疵的紫晶/P2",
  "gemtd_d111":"普通的钻石/D3",
  "gemtd_b111":"普通的蓝宝石/B3",
  "gemtd_y111":"普通的黄玉/Y3",
  "gemtd_r111":"普通的红宝石/R3",
  "gemtd_g111":"普通的翡翠/G3",
  "gemtd_e111":"普通的蛋白石/E3",
  "gemtd_q111":"普通的海晶石/Q3",
  "gemtd_p111":"普通的紫晶/P3",
  "gemtd_d1111":"无瑕的钻石/D4",
  "gemtd_b1111":"无瑕的蓝宝石/B4",
  "gemtd_y1111":"无瑕的黄玉/Y4",
  "gemtd_r1111":"无瑕的红宝石/R4",
  "gemtd_g1111":"无瑕的翡翠/G4",
  "gemtd_e1111":"无瑕的蛋白石/E4",
  "gemtd_q1111":"无瑕的海晶石/Q4",
  "gemtd_p1111":"无瑕的紫晶/P4",
  "gemtd_d11111":"完美的钻石/D5",
  "gemtd_b11111":"完美的蓝宝石/B5",
  "gemtd_y11111":"完美的黄玉/Y5",
  "gemtd_r11111":"完美的红宝石/R5",
  "gemtd_g11111":"完美的翡翠/G5",
  "gemtd_e11111":"完美的蛋白石/E5",
  "gemtd_q11111":"完美的海晶石/Q5",
  "gemtd_p11111":"完美的紫晶/P5",
  "gemtd_d111111":"巨型的钻石/D6",
  "gemtd_b111111":"巨型的蓝宝石/B6",
  "gemtd_y111111":"巨型的黄玉/Y6",
  "gemtd_r111111":"巨型的红宝石/R6",
  "gemtd_g111111":"巨型的翡翠/G6",
  "gemtd_e111111":"巨型的蛋白石/E6",
  "gemtd_q111111":"巨型的海晶石/Q6",
  "gemtd_p111111":"巨型的紫晶/P6",
  "gemtd_zhenjiazhishi":"镇宅之石|4|1",
  "gemtd_baiyin":"白银|0|3",
  "gemtd_kongqueshi":"孔雀石|0|3",
  "gemtd_xingcaihongbaoshi":"星彩红宝石|0|3",
  "gemtd_yu":"玉|0|3",
  "gemtd_furongshi":"芙蓉石|0|3",
  "gemtd_heianfeicui":"黑暗翡翠|1|3",
  "gemtd_huangcailanbaoshi":"黄彩蓝宝石|1|3",
  "gemtd_palayibabixi":"帕拉伊巴碧玺|1|3",
  "gemtd_heisemaoyanshi":"黑色猫眼石|1|3",
  "gemtd_jin":"黄金|1|3",
  "gemtd_fenhongzuanshi":"粉红钻石|1|3",
  "gemtd_jixueshi":"鸡血石|1|3",
  "gemtd_you238":"铀238|1|3",
  "gemtd_baiyinqishi":"白银骑士|1|5",
  "gemtd_xianyandekongqueshi":"鲜艳的孔雀石|1|5",
  "gemtd_xuehonghuoshan":"血红火山|1|5",
  "gemtd_jixiangdezhongguoyu":"吉祥的中国玉|2|7",
  "gemtd_juxingfenhongzuanshi":"巨型粉红钻石|2|11",
  "gemtd_you235":"铀235|2|11",
  "gemtd_jingxindiaozhuodepalayibabixi":"精心雕琢的帕拉伊巴碧玺|2|7",
  "gemtd_gudaidejixueshi":"古代的鸡血石|2|9",
  "gemtd_mirendeqingjinshi":"迷人的青金石|2|5",
  "gemtd_aijijin":"埃及金|2|5",
  "gemtd_yijiazhishi":"卡门-露西亚|3|9",
  "gemtd_heiyaoshi":"黑曜石|3|1",
  "gemtd_manao":"玛瑙|3|1",
  "gemtd_ranshaozhishi":"燃烧陨石|3|1",
  "gemtd_taijiaoxiongdi_tester":"抬轿兄弟",
  "gemtd_haiyangqingyu":"海洋青玉|1|5",
  "gemtd_shenhaizhenzhu":"深海珍珠|1|3",
  "gemtd_xiameishi":"傲娇的虾妹石|3|1",
  "gemtd_maomaoyu":"毛毛鱼",
  "gemtd_xiaomogu":"小蘑菇",
  "gemtd_jiujiu_fly":"啾啾",
  "gemtd_hongshanhu":"红珊瑚|2|7",
  "gemtd_xiaofamuji_fly":"伐士奇",
  "gemtd_cuiyuxiaolong":"翠玉小龙",
  "gemtd_jixiezhanlv":"机械战驴",
  "gemtd_dazuiyaorenxiang":"大嘴咬人箱",
  "gemtd_yaobaidelvgemi":"摇摆的驴革米",
  "gemtd_huoxingche_fly":"火星车卡卡",
  "gemtd_fennenrongyuan_fly":"粉嫩蝾螈",
  "gemtd_xuemobaobao_fly":"血魔宝宝",
  "gemtd_tianmaodigou_fly":"天猫地狗",
  "gemtd_siwangxianzhi":"死亡先知",
  "gemtd_xiaohongmao_fly":"小红毛",
  "gemtd_huguoshenyishi":"金色陛下|3|7",
  "gemtd_siwangxintu":"死亡信徒",
  "gemtd_jilamofashi":"基拉魔法师",
  "gemtd_juniaoduoduo":"巨鸟多多",
  "gemtd_xiaofeixia_fly":"小飞侠",
  "gemtd_feicuimoxiang":"翡翠魔像|2|7",
  "gemtd_feicuimoxiang_bio":"",
  "gemtd_jingangshikulinan":"金刚石库利南|3|9",
  "gemtd_sililankazhixing":"斯里兰卡之星|3|9",
  "gemtd_huaguoshanxiandan":"花果山仙玉|2|7",
  "gemtd_diaofengzhishi":"鲷枫石|3|1",
  "gemtd_geluanshi":"鸽卵石|3|1",
  "gemtd_youbushiban":"诱捕石板|1|1",
  "gemtd_hongliushiban":"洪流石板|1|1",
  "gemtd_zhangqishiban":"瘴气石板|1|1",
  "gemtd_zuzhoushiban":"诅咒石板|1|1",
  "gemtd_haojiaoshiban":"嗥叫石板|1|1",
  "gemtd_suanwushiban":"酸雾石板|1|1",
  "gemtd_mabishiban":"麻痹石板|1|1",
  "gemtd_tianranzumulv":"天然祖母绿|2|5",
  "gemtd_keyinuoerguangmingzhishan":"柯伊诺尔-光明之山|3|13",
  "gemtd_shuaibiankaipayou":"衰变凯帕铀|3|13",
  "gemtd_heiwangzihuangguanhongbaoshi":"黑王子-皇冠红宝石|3|11",
  "gemtd_xingguanglanbaoshi":"星光蓝宝石|3|5",
  "gemtd_haibao":"北地豹眼石|2|7",
  "gemtd_xunjieyuanzumaolv":"迅捷远足毛驴",
  "gemtd_talongaosiji":"獭龙奥斯基",
  "gemtd_jiwanghaidao_fly":"基王海盗",
  "gemtd_xiexiaowo":"蟹小蜗",
  "gemtd_yingwuchuanfu_fly":"鹦鹉船夫",
  "gemtd_ruxingshuimu_fly":"蠕行水母",
  "gemtd_youbushiban_yin":"闪亮的诱捕石板|2|3",
  "gemtd_hongliushiban_yin":"闪亮的洪流石板|2|3",
  "gemtd_zhangqishiban_yin":"闪亮的瘴气石板|2|3",
  "gemtd_haojiaoshiban_yin":"闪亮的嗥叫石板|2|3",
  "gemtd_suanwushiban_yin":"闪亮的酸雾石板|2|3",
  "gemtd_mabishiban_yin":"闪亮的麻痹石板|2|3",
  "gemtd_youbushiban_jin":"流光溢彩的诱捕石板|3|9",
  "gemtd_hongliushiban_jin":"流光溢彩的洪流石板|3|9",
  "gemtd_zhangqishiban_jin":"流光溢彩的瘴气石板|3|9",
  "gemtd_haojiaoshiban_jin":"流光溢彩的嗥叫石板|3|9",
  "gemtd_suanwushiban_jin":"流光溢彩的酸雾石板|3|9",
  "gemtd_mabishiban_jin":"流光溢彩的麻痹石板|3|9",
  "gemtd_kongheshiban":"恐吓石板|1|1",
  "gemtd_xuwushiban":"虚无石板|1|1",
  "gemtd_kongheshiban_yin":"闪亮的恐吓石板|2|3",
  "gemtd_xuwushiban_yin":"闪亮的虚无石板|2|3",
  "gemtd_kongheshiban_jin":"流光溢彩的恐吓石板|3|9",
  "gemtd_xuwushiban_jin":"流光溢彩的虚无石板|3|9",
  "gemtd_crab_smeevil_fly":"大蟹",
  "gemtd_yinhun":"阴魂",
  "gemtd_jihan":"极寒"
  };

function getRandomInt(min, max) {
  min = Math.ceil(min); // 向上取整
  max = Math.floor(max); // 向下取整
  return Math.floor(Math.random() * (max - min + 1)) + min; // 含最小值，含最大值 
}
Page({
  data: {
    pickerArray: ['1P', '2P', '3P', '4P'],
    pickerIndex: 0,
    rankList: [],
    record: {},
    game:{showFloatingDiv: true},
    currectFloat:{},
    floatingDivStyle: '', // 用于控制浮窗的样式
  },
  pickerChange: function (e) {
    let game = this.data.game
    game.showFloatingDiv = true
    this.setData({
      pickerIndex: e.detail.value,
      game:game
    });
    this.getRankList(Number(this.data.pickerIndex) + 1)
  },
  onLoad: function (options) {
    const time = options.selectedItem; // 这里可以获取到传递过来的下拉菜单选中项
    const db = wx.cloud.database();
    const that = this
    db.collection('rank').where({
      ["time"]: time
    }).get({
      success: function (res) {
        const record = res.data[0];
        console.log(record)
        that.setData({
          record: record
        })
        that.getRankList(1);
        console.log(that.data.rankList)
      }
    })
  },
  getRankList: function (index) {
    var rankList = []
    const selectP = "p" + index
    const data = this.data.record.rank.data[selectP]
    data.forEach(element => {
      let rank = {}
      let avatars = []
      const player = element.player_ids.split(",")
      player.forEach(element => {
        let avatar = {}
        avatar.player = element
        if(this.data.record?.user?.[element]?.avatar){
          avatar.avatar = this.data.record.user[element].avatar
        }else{
          avatar.avatar = "/static/image/default.png"
        }
        avatars.push(avatar)
      });
      rank.avatars = avatars
      rank.score = element.kill
      rank.towers = element.towers
      rank.elites = element.towers.split('|')[4]
      rankList.push(rank)
    });
    this.setData({
      rankList: rankList
    })
  },
  pickAvatar: function (e) {
    const searchId = e.currentTarget.dataset.player;
    wx.showLoading({
      title: '请稍等',
      mask: true // 可选，表示是否显示透明蒙层，防止触摸穿透
    });
    // 执行搜索操作
    let url = "http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=0A73E70ED398C36AD29C0AB210F71B3D&steamids=" + searchId
    // 调用云函数进行搜索
    wx.cloud.callFunction({
      name: 'requestGEM',
      data: {
        url: url
      },
      success: res => {
        const app = getApp();
        app.globalData.steamInfo = res.result.response.players[0];
        app.eventHandler.emit('steamInfoUpdate', res.result.response.players[0]);
        wx.setStorageSync('steamInfo', res.result.response.players[0])
        let avatarInfo = wx.getStorageSync('avatarInfo')
        if (!avatarInfo) {
          wx.setStorageSync('avatarInfo', [])
          avatarInfo = wx.getStorageSync('avatarInfo')
        }
        if (!avatarInfo.some(element => element["id"] === res.result.response.players[0].steamid)) {
          let avatar = {}
          avatar.avatarUrl = res.result.response.players[0].avatarmedium
          avatar.name = res.result.response.players[0].personaname
          avatar.id = res.result.response.players[0].steamid
          avatarInfo.push(avatar)
          console.log("存储缓存")
        }
        wx.setStorageSync('avatarInfo', avatarInfo)
      },
      fail: res => {
        console.error(res)
      }
    });
    const randomNumber = getRandomInt(1, 10000);
    url = "http://gemtd.ppbizon.com/gemtd/202203/heros/get/@" + searchId + "?hehe=" + randomNumber
    wx.cloud.callFunction({
      name: 'requestGEM',
      data: {
        url: url
      },
      success: res => {
        wx.setStorageSync('gemInfo', res.result.data[searchId])
        wx.navigateTo({
          url: '/pages/playerInfo/playerInfo'
        });
      }
    })
    wx.hideLoading()
  },
  showFloatingDiv: function (e) {
    let x = e.currentTarget.offsetLeft; // 触摸点相对于页面的X坐标
    let y = e.changedTouches[0].clientY; // 触摸点相对于页面的Y坐标
    const screenHeight = wx.getSystemInfoSync().windowHeight; // 获取屏幕高度
    let game = this.data.game
    const index = e.currentTarget.dataset.id;
    if(game.id == index){
      game.showFloatingDiv = !game.showFloatingDiv
      this.setData({game:game})
      return 
    }else if(game.showFloatingDiv == true){
      game.showFloatingDiv = !game.showFloatingDiv
    }
    game.id = index

    // 浮窗的预估尺寸
    const floatingDivWidth = 220;
    const floatingDivHeight = 400;

    // 根据屏幕宽度调整X坐标，防止浮窗超出屏幕右边缘
    x = x - floatingDivWidth - 10; // 调整X坐标
    // 判断触摸点在屏幕的上半部还是下半部，并调整Y坐标
    if (y < screenHeight / 2) {
      // 上半部，浮窗在触摸点的右下方（不需要调整Y坐标）
    } else {
      y = y - floatingDivHeight; // 防止浮窗超出屏幕上边缘
    }
    game.positionStyle = `left: ${x}px; top: ${y}px;`;

    //得到塔信息
    let info = [];
    const str = e.currentTarget.dataset.game;
    const time = str.split('|')[2];
    const restime = new Date(1 * str.split('|')[6]).toLocaleString();

    function formatTime(t) {
      if (t < 10) return "0" + t;
      return t;
    }
    let time_str = Math.floor(time / 3600) + ":" + formatTime(Math.floor(time / 60 % 60)) + ":" + formatTime(Math.round(time % 60 * 100) / 100);

    info.push({"key": "波数","value": str.split('|')[1]});
    info.push({"key": "耗时","value": time_str});
    info.push({"key": "剩余金币","value": str.split('|')[3]});
    info.push({"key": "精英数","value": str.split('|')[4]});
    info.push({"key": "迷宫长度","value": str.split('|')[5]});
    info.push({"key": "结算时间","value": restime});
    game.info = info
    const result = this.parseAndTranslate(str);
    game.towers = result.towers
    game.counters = result.counters
    this.setData({
      game:game
    });
  },
  parseAndTranslate: function (str, dict) {
    let items = str.split('|')[0].split(',');
    items.pop()

    let towers = [];
    let counter = 0;
    items.forEach(item => {
      let [key, num] = item.split(':');
      let [name, level, count] = tower_name[key].split('|');
      
      towers.push({
        name: name,
        value: parseInt(num),
        level: level
      });
      counter += parseInt(num) * parseInt(count)

    });
    towers.sort((a, b) => b.level - a.level);
    return  {"towers":towers, "counters":counter};
  },
})